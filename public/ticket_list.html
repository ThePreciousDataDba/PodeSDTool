<div class="subheader">
	<h1 class="subheader-title">
		<i class='subheader-icon fal fa-plus-circle'></i> Service Requests: <span id='headerFilterName' class='fw-300'>viewType</span>
		<small>
			Manage Engine Service Desk++
		</small>
	</h1>
</div>
<div class="row">
	<div class="col-xl-12">
		<div class="input-group input-group-lg mb-g">
			<input type="text" class="form-control shadow-inset-2" placeholder="Search Threads">
			<div class="input-group-append">
				<span class="input-group-text"><i class="fal fa-search"></i></span>
			</div>
		</div>
		<div class="card mb-g border shadow-0">
			<div class="card-header bg-white">
				<div class="row no-gutters align-items-center">
					<div class="col">
						<span class="h6 font-weight-bold text-uppercase">Account information & Security</span>
					</div>
					<div class="col d-flex align-items-center">
						<a href="javascript:void(0);" class="btn btn-success shadow-0 btn-sm ml-auto flex-shrink-0">New Thread</a>
					</div>
				</div>
			</div>
			<div class="card-header bg-white p-0">
				<div class="row no-gutters row-grid align-items-stretch">
					<div class="col-12 col-md">
						<div class="text-uppercase text-muted py-2 px-3">Title</div>
					</div>
					<div class="col-sm-6 col-md-2 col-xl-1 hidden-md-down">
						<div class="text-uppercase text-muted py-2 px-3">Replies</div>
					</div>
					<div class="col-sm-6 col-md-3 hidden-md-down">
						<div class="text-uppercase text-muted py-2 px-3">Last update</div>
					</div>
				</div>
			</div>
			<div class="card-body p-0">
				<div id="ticketList" class="row no-gutters row-grid">

				</div>
			</div>
		</div>
		<ul class="pagination mt-3">
			<li class="page-item">
				<a class="page-link" href="javascript:incrementPage(-1);" aria-label="Previous">
					<span aria-hidden="true"><i class="fal fa-chevron-left"></i></span>
				</a>
			</li>
			<li class="page-item"><a class="page-link" href="javascript:getRequests(1);">1</a></li>
			<li class="page-item"><a class="page-link" href="javascript:getRequests(2);">2</a></li>
			<li class="page-item"><a class="page-link" href="javascript:getRequests(3);">3</a></li>
			<li class="page-item">
				<a class="page-link" href="javascript:incrementPage(1);" aria-label="Next">
					<span aria-hidden="true"><i class="fal fa-chevron-right"></i></span>
				</a>
			</li>
		</ul>
	</div>
</div>

<script id="ticketListTemplate" type="text/x-handlebars-template">
	<div class="col-12">
		<div class="row no-gutters row-grid align-items-stretch">
			<div class="col-md">
				<div class="p-3">
					<div class="d-flex flex-column">
						<a href="#ticket_view.html?id={{id}}" class="fs-lg fw-500 d-flex align-items-start">
							{{subject}}<span class="badge badge-warning ml-auto">{{status.name}}</span>
						</a>
						<div class="d-block text-muted fs-sm">
							Created by <a href="#page_profile.html?user={{requester.name}}" class="text-info">{{requester.name}}</a> on {{created_time.display_value}}
						</div>
					</div>
				</div>
			</div>
			<div class="col-4 col-md-2 col-xl-1 hidden-md-down">
				<div class="p-3 p-md-3">
					<span class="d-block text-muted">Priority: <i>{{priority.name}}</i></span>
					<span class="d-block text-muted">Overdue: <i>{{is_overdue}}</i></span>
				</div>
			</div>
			<div class="col-8 col-md-3 hidden-md-down">
				<div class="p-3 p-md-3">
					<div class="d-flex align-items-center">
						<div class="d-inline-block align-middle status status-sm mr-2">
							<span class="profile-image-md rounded-circle d-block" style="background-image:url('img/demo/avatars/avatar.png'); background-size: cover;"></span>
						</div>
						<div class="flex-1 min-width-0">
							<a href="javascript:void(0)" class="d-block text-truncate">
								{{short_description}}
							</a>
							<div class="text-muted small text-truncate">
								Today, 05:25 <a href="javascript:void(0)" class="text-info">{{group.name}}</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</script>

<script>
	var ticketsPage = new urlPM(window.location.href);

	function getRequests(page){
		if(page <= 1){
			ticketsPage.setParam('page', null);
		}else{
			ticketsPage.setParam('page', page);
		}
		ticketsPage.load();

		$.ajax({
		  type: "POST",
		  contentType: "application/json",
		  url: "api/v3/requests",
		  data: JSON.stringify({
			list_info:{
				row_count: 10,
				start_index: ((page-1) * 10),
				get_total_count: true,
				fields_required: ["id","priority","requester","created_by","is_overdue","group","short_description","status","subject","created_time","on_behalf_of"]
			}
		  }),
		  success : function(response) {
			var responseStatus = response.response_status[0];

			if(responseStatus.status_code != 2000) {
				console.log("API Error - " + responseStatus.status + "(" + responseStatus.status_code + ")");
				return;
			}
			console.log(response.requests);

			var tableHTML = '';
			var requests = response.requests;
			var listInfo = response.list_info;
			var templateSource   = document.getElementById("ticketListTemplate").innerHTML;
			var template = Handlebars.compile(templateSource);

			$.each(requests, function(requestIndex, requestData){
				$.each(requestData, function(index, value){
					if(value === null){
						requestData[index] = {
							name:''
						};
					}
				});

				tableHTML += template(requestData);
			 });

			 $("#ticketList").html(tableHTML);
		  },
		  error : function(request,error){alert(request);}
		});
	};

	function incrementPage(direction){
		var desiredPage = Number(ticketsPage.getParam('page',1)) + direction;
		if(desiredPage < 1) {
			desiredPage = 1;
		}

		getRequests(desiredPage);
	}

	getRequests(ticketsPage.getParam('page',0));
</script>
