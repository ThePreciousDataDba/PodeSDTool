<script id="ticketView_Header" type="text/x-handlebars-template">
	<div class="subheader">
		<h1 class="subheader-title">
			<i class='subheader-icon fal fa-plus-circle'></i> {{subject}}: <span id='headerTicketID' class='fw-300'>#{{id}}</span>
			<small>
				{{mode.name}} / {{template.name}} / {{group.name}} / {{category.name}} / {{subcategory.name}}
			</small>
		</h1>
	</div>
</script>

<div class="row">
	<div id="ticket_header"  class="col-xl-12">

	</div>
</div>

<div class="row">
	<div id="ticket_leftColumn"class="col-xl-9">


		<div id="ticket_mainPost">

		</div>

		<div id="ticket_messages">

		</div>

	</div>

	<div id="ticket_rightColumn"class="col-xl-3">

	</div>
</div>

<script id="ticketView_mainPost" type="text/x-handlebars-template">
	<div class="card mb-g border shadow-0">
		<div class="card-header bg-white p-0">
			<div class="p-3 d-flex flex-row">
				<div class="d-block flex-shrink-0">
					<img src="img/demo/avatars/avatar.png" class="img-fluid img-thumbnail" alt="">
				</div>
				<div class="d-block ml-2">
					<span class="h6 font-weight-bold text-uppercase d-block m-0"><a href="#page_profile.html?user={{requester.name}}">{{requester.name}}</a></span>
					Affected User: <span class="fs-sm h6 fw-500 mb-0"><a href="#page_profile.html?user={{on_behalf_of.name}}">{{on_behalf_of.name}}</a>&nbsp;</span>
					<span class="text-muted fs-xs font-italic d-block">{{created_time.display_value}}</span>
				</div>
				<a href="javascript:void(0);" class="d-inline-flex align-items-center text-dark ml-auto align-self-start">
					<span class="badge badge-warning ml-auto">{{status.name}}</span>
				</a>
			</div>
		</div>
		<div id="mainPost_{{id}}" class="card-body ">
		</div>
		<div class="card-footer">
			<div class="d-flex align-items-center">
				<a href="javascript:void(0);" class="flex-shrink-0 ml-auto">Reply <i class="fal fa-reply ml-2"></i> </a>
			</div>
		</div>
	</div>
</script>


<script id="ticketView_messagePost" type="text/x-handlebars-template">
	<div class="card mb-g border shadow-0">
		<div class="card-header bg-white p-0">
			<div class="p-3 d-flex flex-row">
				<div class="d-block">
					<img src="img/demo/avatars/avatar.png" class="img-fluid img-thumbnail" width="60%" height="60%" style="width:36px" alt="">
				</div>
				<div class="d-block ml-2">
					<span class="h6 font-weight-bold text-uppercase d-block m-0"><a href="#page_profile.html?user={{created_by.name}}">{{created_by.name}}</a></span>
					<span class="text-muted fs-xs font-italic d-block">{{created_time.display_value}}</span>
				</div>
				<a href="javascript:void(0);" class="d-inline-flex align-items-center text-dark ml-auto align-self-start">
					<span class="badge badge-warning ml-auto">{{show_to_requester}}</span>
				</a>
			</div>
		</div>
		<div id="{{type}}_{{id}}" class="card-body ">
		</div>
		<div class="card-footer">
			<div class="d-flex align-items-center">
				<a href="javascript:void(0);" class="flex-shrink-0 ml-auto">Reply <i class="fal fa-reply ml-2"></i> </a>
			</div>
		</div>
	</div>
</script>

<script id="userCardTemplate" type="text/x-handlebars-template">

			<div class="card mb-g rounded-top">
				<div class="row no-gutters row-grid">
					<div class="col-12">
						<div class="d-flex flex-column align-items-center justify-content-center p-4">
							<img src="img/demo/avatars/avatar.png" class="rounded-circle shadow-2 img-thumbnail" alt="">
							<h5 class="mb-0 fw-700 text-center mt-3">
								{{displayName}}<small class="text-muted mb-0">{{Title}}</small><small class="text-muted mb-0">{{company}} -- {{department}}</small>
								<address class="fs-sm fw-400 mt-2 mb-0 text-muted">
									<i class="fas fa-map-pin mr-2"></i> {{StreetAddress}}, {{l}}, {{st}}, {{PostalCode}}
								</address>
							</h5>
						</div>
					</div>
					<div class="col-4">
						<div class="text-center py-3">
							<h5 class="mb-0 fw-700">
								{{whenCreated}}<small class="text-muted mb-0">Start Date</small>
							</h5>
						</div>
					</div>
					<div class="col-4">
						<div class="text-center py-3">
							<h5 class="mb-0 fw-700">
								{{employeeID}}<small class="text-muted mb-0">Employee ID</small>
							</h5>
						</div>
					</div>
					<div class="col-4">
						<div class="text-center py-3">
							<h5 class="mb-0 fw-700">
								{{accountStatus}}<small class="text-muted mb-0">Active Employee</small>
							</h5>
						</div>
					</div>
					<div class="col-12">
						<div class="p-3 text-center">
							<a href="tel:{{telephoneNumber}}" class="mt-1 d-block fs-sm fw-400 text-dark">
								<i class="fas fa-mobile-alt text-muted mr-2"></i> {{telephoneNumber}}
							</a>
							<a href="mailto:{{mail}}" class="mt-1 d-block fs-sm fw-400 text-dark">
								<i class="fas fa-mouse-pointer text-muted mr-2"></i> {{mail}}
							</a>
						</div>
						<div class="p-3 text-center">
							<a href="javascript:void(0);" class="btn-link font-weight-bold">E-mail</a> <span class="text-primary d-inline-block mx-3">&#9679;</span>
							<a href="javascript:void(0);" class="btn-link font-weight-bold">Skype Message</a> <span class="text-primary d-inline-block mx-3">&#9679;</span>
							<a href="javascript:void(0);" class="btn-link font-weight-bold">Connect</a>
						</div>
					</div>
				</div>
			</div>
</script>

<script>
	var requestPage = new urlPM(window.location.href);
	var requestData = {};

	function loadNotes(id){
		$.ajax({
			type: "POST",
			contentType: "application/json",
			async: false,
			url: "api/v3/requests/"+id+"/notes",
			data: JSON.stringify({
				list_info:{
					fields_required: ["id","description","created_by","created_time","show_to_requester"]
				}
			}),
			success : function(response) {
				//console.log(response);
				requestData["notes"] = response.notes;
			},
			error : function(request,error){
				console.log(request);
			}
		});
	}

	function getAllConversations(id){
		$.ajax({
			type: "POST",
			contentType: "application/json",
			async: false,
			url: "api/v3/requests/"+id+"/conversations",
			data: JSON.stringify({
				list_info:{
					sort_field: "sent_time",
					sort_order: "desc",
					start_index: "1"
				}
			}),
			success : function(response) {
				requestData["conversations"] = [];
				response.conversations.forEach(function(conv) {
					getConversationDetails(conv.content_url);
				});
			},
			error : function(request,error){
				console.log(request);
			}
		});
	}


	function getConversationDetails(fetchURL){
		$.ajax({
			type: "GET",
			contentType: "application/json",
			async: false,
			url: fetchURL,
			success : function(response) {
				//console.log(response);
				requestData.conversations.push(response.notification);
			},
			error : function(request,error){
				console.log(request);
			}
		});
	}

	function loadSummary(id){
		$.ajax({
			type: "POST",
			contentType: "application/json",
			url: "api/v3/requests/"+id+"/summary",
			data: JSON.stringify({
				list_info:{
					fields_required: ["task_completed_count","task_total_count","dependency_count","note_count","link_request_count"]
				}
			}),
			success : function(response) {
				//console.log(response);
			},
			error : function(request,error){
				console.log(request);
			}
		});
	}

	function parseDescriptionHTML(htmlString,uniqueID){
		return (htmlString).replace(/<\s*blockquote[^>]*>/gi,'<blockquote class="font-italic fw-sm bg-faded border border-top-0 border-right-0 border-bottom-0 p-3">')
				.replace(/(<\/b><br \/><\/div>)/gi,'</b></div>')
				.replace(/(<div><br \/><\/div>){2,2}/gi,'<br>')
				.replace(/(?<=\/WorkOrder\/)\d{5}/gi,requestData.request.id)
				.replace(/src="\/inlineimages\//gi,"src=\"https://sdp.website.org/inlineimages/")
				.replace(/src="\/inline\//gi,"src=\"https://sdp.website.org/inline/")
				.replace(/<p><\/p>/gi,"")
				.replace(/((<div[^>]*>)(Category : ).*)/gi,"<div class='accordion accordion-outline' id='unique_accordion_id'><div class='card'><div class='card-header'><a href='javascript:void(0);' class='card-title' data-toggle='collapse' data-target='#unique_accordion_id-a' aria-expanded='false'><i class='fal fa-file-medical-alt width-2 fs-xl'></i>Previous replies in this post...<span class='ml-auto'><span class='collapsed-reveal'><i class='fal fa-minus fs-xl'></i></span><span class='collapsed-hidden'><i class='fal fa-plus fs-xl'></i></span></span></a></div><div id='unique_accordion_id-a' class='collapse' data-parent='#unique_accordion_id'><div class='card-body'>$1</div></div></div></div>")
				.replace(/unique_accordion_id/gi,"accordion_"+uniqueID);
	}

	function loadUserData(userName){
		$.ajax({
			type: "POST",
			contentType: "application/json",
			cache:true,
			async:false,
			url: "api/adp/user",
			data:JSON.stringify({
				user: (userName.split('@')[0]),
				mode: "loginID"
			}),
			success : function(response) {
				console.log(response);
				// Format/change/create new properties from the fetched AD data.
				response["accountStatus"] = (response["userAccountControl"] == 512) ? "Yes" : "No";
				const dateValues = ["whenChanged","whenCreated","PasswordLastSet","LastLogonDate"];

				dateValues.forEach(adDate => {
					var date = new Date(parseInt((response[adDate].substring(6, 19))));
					response[adDate] = (date.toDateString());
				});

				var userCardTemplateSource = document.getElementById("userCardTemplate").innerHTML;
				var userCardTemplate = Handlebars.compile(userCardTemplateSource);
				$("#ticket_rightColumn").append(userCardTemplate(response));
			},
			error : function(request,error){
				console.log(request);
			}
		});
	}

	function processRequestData(){
		var mainPost = parseDescriptionHTML(requestData.request.description,requestData.request.id);
		console.log(requestData);

		loadUserData(requestData.request.requester.email_id);

		if(requestData.request.on_behalf_of != null) {
			loadUserData(requestData.request.on_behalf_of.email_id);
		}

		if(requestData.request.created_by.email_id != requestData.request.requester.email_id){
			loadUserData(requestData.request.created_by.email_id);
		}

		var template_mainPost_source = document.getElementById("ticketView_mainPost").innerHTML;
		var template_mainPost = Handlebars.compile(template_mainPost_source);
		$("#ticket_mainPost").html(template_mainPost(requestData.request));
		$("#mainPost_"+requestData.request.id).html(mainPost);

		var template_header_source = document.getElementById("ticketView_Header").innerHTML;
		var template_header = Handlebars.compile(template_header_source);
		$("#ticket_header").html(template_header(requestData.request));

		var allMessages = [];

		if(requestData.notes) {
			requestData.notes.forEach(function(note) {
				allMessages.push({
					type: "note",
					id: note.id,
					created_time: note.created_time,
					created_by: note.created_by,
					description: parseDescriptionHTML(note.description,note.id),
					show_to_requester: note.show_to_requester
				});
			});
		}

		if(requestData.conversations) {
			requestData.conversations.forEach(function(convo) {
				allMessages.push ({
					type: convo.type,
					id: convo.id,
					created_time: convo.sent_time,
					created_by: convo.from,
					description: parseDescriptionHTML(convo.description,convo.id),
					show_to_requester: convo.show_to_requester,
					has_attachments: convo.has_attachments,
					attachments: convo.attachments,
					sent_to: convo.to,
					sent_cc: convo.cc
				});
			});
		}

		function sortByTime(a, b) {
			return b.created_time.value - a.created_time.value;
		}

		allMessages.sort(sortByTime);
		console.log(allMessages);

		var template_messageSource = document.getElementById("ticketView_messagePost").innerHTML;
		var templateMessage = Handlebars.compile(template_messageSource);

		allMessages.forEach(function(message) {
			$("#ticket_messages").append(templateMessage(message));
			$("#"+message.type+"_"+message.id).html(message.description);
		});
	}

	function getRequestData(id){
		$.ajax({
			type: "POST",
			contentType: "application/json",
			url: "api/v3/requests/"+id,

			success : function(response) {
				//console.log(response);

				var responseStatus = response.response_status;

				if(responseStatus.status_code != 2000) {
					console.log("API Error - " + responseStatus.status + "(" + responseStatus.status_code + ")");
					return;
				}

				requestData["request"] = response.request;

				if(requestData.request.has_notes){
					loadNotes(id);
				}

				if(requestData.request.has_conversation){
					getAllConversations(id);
				}

				processRequestData();
			},
			error : function(request,error){
				console.log(request);
			}
		});
	};

	//jQuery(document).ready(function() {
	getRequestData(requestPage.getParam('id',-1));
</script>
